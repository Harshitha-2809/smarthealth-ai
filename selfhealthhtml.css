<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SelfHealth AI - Smart Symptom Analysis</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
    
    /* Header */
    header { background: rgba(255,255,255,0.95); padding: 15px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    header h1 { color: #667eea; font-size: 24px; }
    
    /* Main container */
    .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
    
    /* Hero section */
    .hero { background: white; border-radius: 12px; padding: 40px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); margin-bottom: 30px; text-align: center; }
    .hero h2 { color: #667eea; margin-bottom: 10px; font-size: 28px; }
    .hero p { color: #666; margin-bottom: 20px; line-height: 1.6; }
    
    /* Input section */
    .input-section { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); margin-bottom: 20px; }
    .input-section h3 { color: #333; margin-bottom: 15px; }
    
    textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical; min-height: 100px; }
    textarea:focus { outline: none; border-color: #667eea; }
    
    /* Severity selector */
    .severity-selector { margin: 20px 0; }
    .severity-selector label { display: block; margin-bottom: 10px; font-weight: 600; color: #333; }
    .severity-buttons { display: flex; gap: 10px; }
    .severity-btn { padding: 10px 20px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
    .severity-btn:hover { border-color: #667eea; }
    .severity-btn.active { background: #667eea; color: white; border-color: #667eea; }
    
    /* Buttons */
    .btn-primary, .btn-secondary { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 14px; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5568d3; transform: translateY(-2px); }
    .btn-primary:disabled { background: #999; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #f0f0f0; color: #333; border: 1px solid #ddd; }
    .btn-secondary:hover { background: #e0e0e0; }
    
    /* Results section */
    .result-card { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: none; }
    .result-card h3 { color: #667eea; margin-bottom: 15px; }
    
    .severity-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; color: white; font-weight: 600; margin-bottom: 15px; }
    .severity-badge.severity-green { background: #4caf50; }
    .severity-badge.severity-yellow { background: #ff9800; }
    .severity-badge.severity-red { background: #f44336; }
    
    .condition-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
    .condition-name { font-weight: 600; color: #333; }
    .probability { display: flex; align-items: center; gap: 10px; }
    .probability-bar { width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .probability-fill { height: 100%; background: #667eea; }
    .probability-text { font-weight: 600; color: #667eea; min-width: 40px; text-align: right; }
    
    .recommendations-box { margin-top: 20px; }
    .recommendations-box h4 { color: #333; margin-bottom: 10px; }
    .recommendations-box ul { list-style: none; }
    .recommendations-box li { padding: 8px 0; color: #555; padding-left: 20px; position: relative; }
    .recommendations-box li:before { content: "‚úì"; position: absolute; left: 0; color: #4caf50; font-weight: bold; }
    
    /* Modal */
    .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999; }
    .modal.show { display: flex; }
    .modal-card { width: 400px; max-width: 95%; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); }
    .modal-card h3 { color: #667eea; margin-bottom: 10px; }
    .modal-card p { color: #555; font-size: 0.9rem; margin-bottom: 12px; }
    
    input[type="text"], input[type="email"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: inherit; }
    input[type="text"]:focus, input[type="email"]:focus { outline: none; border-color: #667eea; }
    
    .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px; }
    
    /* Spinner */
    .spinner { width: 28px; height: 28px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; animation: spin 0.9s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Demo placeholder */
    .demo-placeholder { background: white; border-radius: 12px; padding: 30px; text-align: center; color: #999; }
    
    /* Slide Navigation */
    .slides-container { position: relative; overflow: hidden; }
    .slide { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.15); display: none; animation: slideIn 0.5s ease-in-out; }
    .slide.active { display: block; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    
    .slide h2 { color: #667eea; margin-bottom: 20px; font-size: 24px; }
    .slide p { color: #666; margin-bottom: 15px; line-height: 1.6; }
    
    .quick-select { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 20px 0; }
    .quick-btn { padding: 15px; border: 2px solid #ddd; background: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; text-align: center; }
    .quick-btn:hover { border-color: #667eea; background: #f0f4ff; }
    .quick-btn.selected { background: #667eea; color: white; border-color: #667eea; }
    
    .slide-navigation { display: flex; gap: 10px; margin-top: 30px; justify-content: space-between; }
    .slide-progress { display: flex; gap: 5px; align-items: center; }
    .progress-dot { width: 10px; height: 10px; border-radius: 50%; background: #ddd; transition: all 0.3s; }
    .progress-dot.active { background: #667eea; width: 30px; border-radius: 5px; }
    
    .input-field { display: flex; flex-direction: column; margin: 15px 0; }
    .input-field label { font-weight: 600; margin-bottom: 8px; color: #333; }
    .input-field input, .input-field textarea { padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-family: inherit; }
    .input-field input:focus, .input-field textarea:focus { outline: none; border-color: #667eea; }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>üè• SelfHealth AI</h1>
      <p>Smart Symptom Analysis</p>
    </div>
  </header>

  <div class="container">
    <div class="hero">
      <h2>Symptom Analysis & Guidance</h2>
      <p>Step by step symptom analysis for better health understanding</p>
    </div>

    <!-- Slides Container -->
    <div class="slides-container">
      <!-- Slide 1: Symptom Input -->
      <div class="slide active" id="slide-1">
        <h2>Step 1: What symptoms do you have?</h2>
        <p>Describe your primary symptoms in detail.</p>
        <div class="input-field">
          <label>Symptom Description:</label>
          <textarea id="symptomInput" placeholder="E.g., I have a high fever, severe headache, and body aches since yesterday..." style="min-height: 120px;"></textarea>
        </div>
        <p style="font-size: 12px; color: #999; margin-top: 10px;">üí° Try: fever, cold, cough, vomit, diabetes, bp, headache, weakness, body pain</p>
        <div class="slide-navigation">
          <div class="slide-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
          </div>
          <button class="btn-primary" onclick="goToSlide(2)">Next</button>
        </div>
      </div>

      <!-- Slide 2: Severity Selection -->
      <div class="slide" id="slide-2">
        <h2>Step 2: How severe are your symptoms?</h2>
        <p>Select the severity level that best describes your condition.</p>
        <div class="quick-select">
          <button class="quick-btn" onclick="setSeverity('low')">
            <div style="font-size: 24px;">üü¢</div>
            <div>Low</div>
            <div style="font-size: 11px; color: #999;">Mild symptoms</div>
          </button>
          <button class="quick-btn" onclick="setSeverity('medium')">
            <div style="font-size: 24px;">üü°</div>
            <div>Medium</div>
            <div style="font-size: 11px; color: #999;">Moderate symptoms</div>
          </button>
          <button class="quick-btn" onclick="setSeverity('high')">
            <div style="font-size: 24px;">üî¥</div>
            <div>High</div>
            <div style="font-size: 11px; color: #999;">Severe symptoms</div>
          </button>
        </div>
        <div style="margin-top: 15px; padding: 15px; background: #f0f4ff; border-left: 4px solid #667eea; border-radius: 6px;">
          <strong>Selected:</strong> <span id="selectedSeverityDisplay">Not selected</span>
        </div>
        <div class="slide-navigation">
          <div class="slide-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-secondary" onclick="goToSlide(1)">Back</button>
            <button class="btn-primary" onclick="goToSlide(3)">Next</button>
          </div>
        </div>
      </div>

      <!-- Slide 3: Duration -->
      <div class="slide" id="slide-3">
        <h2>Step 3: How long have you had these symptoms?</h2>
        <p>This helps us understand the timeline of your condition.</p>
        <div class="quick-select">
          <button class="quick-btn" onclick="setDuration('less-than-1-day'); goToSlide(4)">Less than 1 day</button>
          <button class="quick-btn" onclick="setDuration('1-3-days'); goToSlide(4)">1-3 days</button>
          <button class="quick-btn" onclick="setDuration('4-7-days'); goToSlide(4)">4-7 days</button>
          <button class="quick-btn" onclick="setDuration('more-than-1-week'); goToSlide(4)">More than 1 week</button>
        </div>
        <div class="slide-navigation">
          <div class="slide-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-secondary" onclick="goToSlide(2)">Back</button>
          </div>
        </div>
      </div>

      <!-- Slide 4: Results -->
      <div class="slide" id="slide-4">
        <h2>Analysis Results</h2>
        <div class="result-card" style="box-shadow: none; padding: 0; display: block;">
          <h3>Symptoms: <span id="resultSymptom"></span></h3>
          <div class="severity-badge" id="severityBadge">Moderate</div>
          
          <h4 style="margin-top: 20px; color: #333;">Possible Conditions</h4>
          <div id="conditionsList"></div>
          
          <div class="recommendations-box">
            <h4>Recommendations</h4>
            <ul id="recommendationsList"></ul>
          </div>
        </div>
        <div class="slide-navigation">
          <div class="slide-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
            <div class="progress-dot active"></div>
          </div>
          <div style="display: flex; gap: 10px; align-items:center; flex-wrap:wrap;">
            <button class="btn-secondary" onclick="goToSlide(1)">Start Over</button>
            <button class="btn-secondary" id="findHospitalsBtn" onclick="openHospitalSearchPanel()">üè• Find Hospitals</button>
            <button class="btn-primary" id="consultButton2" onclick="openConsultModal()" style="display: none;">Request Consult</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hospitals Panel - DEPRECATED (merged into unified address panel) -->
    <!-- Kept for backward compatibility but hidden -->
    <div id="hospitalsPanel" class="slide" style="display:none; margin-top:20px;">
      <h2>Nearby Hospitals</h2>
      <div style="display:flex; gap:20px; align-items:flex-start;">
        <div style="flex:1; min-width:250px;">
          <ul id="hospitalsList" style="list-style:none; padding:0;"></ul>
        </div>
        <div id="mapContainer" style="width:400px; height:300px; background:#eee; border-radius:8px; overflow:hidden; flex:0 0 400px;">
          <div id="map" style="width:100%; height:100%;"></div>
        </div>
      </div>
    </div>

    <!-- Unified Hospital Search Panel -->
    <div id="addressPanel" class="slide" style="display:none; margin-top:20px;">
      <h2>Find Hospitals Near You</h2>
      <p>Search by address, use current location, or search by region</p>
      
      <!-- Search Options -->
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 20px 0;">
        <!-- Option 1: Address Search -->
        <div style="padding: 15px; border: 2px solid #ddd; border-radius: 8px;">
          <h4 style="color: #333; margin-bottom: 10px;">üìç By Address</h4>
          <div style="display: flex; gap: 8px; flex-direction: column;">
            <input id="addressInput" type="text" placeholder="Enter address" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
            <button class="btn-primary" onclick="searchHospitalsByAddress()" style="padding: 8px;">Search</button>
          </div>
        </div>
        
        <!-- Option 2: Current Location -->
        <div style="padding: 15px; border: 2px solid #ddd; border-radius: 8px;">
          <h4 style="color: #333; margin-bottom: 10px;">üìå Current Location</h4>
          <div style="display: flex; gap: 8px; flex-direction: column;">
            <p style="font-size: 12px; color: #666;">Find hospitals near your GPS location</p>
            <button class="btn-primary" onclick="searchHospitalsByGPS()" style="padding: 8px;">Use My Location</button>
          </div>
        </div>
        
        <!-- Option 3: Region Search -->
        <div style="padding: 15px; border: 2px solid #ddd; border-radius: 8px;">
          <h4 style="color: #333; margin-bottom: 10px;">üó∫Ô∏è By Region/City</h4>
          <div style="display: flex; gap: 8px; flex-direction: column;">
            <input id="regionInput" type="text" placeholder="City or region" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
              <button class="btn-primary" onclick="searchHospitalsByRegion()" style="padding: 8px;">Search</button>
          </div>
        </div>
      </div>
      
      <!-- Status Display -->
      <div id="addressStatus" style="font-size: 12px; color: #666; margin: 15px 0; padding: 10px; background: #f0f4ff; border-radius: 4px; border-left: 4px solid #667eea;">
        <span id="statusText">Ready to search. Choose any method above.</span>
      </div>
      
      <!-- Results -->
      <div style="display:flex; gap:20px; align-items:flex-start; margin-top:20px;">
        <div style="flex:1; min-width:250px;">
          <h4 style="color:#333; margin-bottom:10px;">Nearby Hospitals (<span id="hospitalCount">0</span>)</h4>
          <ul id="addressHospitalsList" style="list-style:none; padding:0;"></ul>
        </div>
        <div id="addressMapContainer" style="width:400px; height:350px; background:#eee; border-radius:8px; overflow:hidden; flex:0 0 400px;">
          <div id="addressMap" style="width:100%; height:100%;"></div>
        </div>
      </div>
    </div>

    <!-- Doctors Panel -->
    <!-- Consult Modal -->
  <div id="consultModal" class="modal" role="dialog" aria-hidden="true">
    <div class="modal-card">
      <h3>Request Doctor Consultation</h3>
      <p>Provide your contact details. A clinician will review your case.</p>
      <input id="consultName" type="text" placeholder="Full name">
      <input id="consultEmail" type="email" placeholder="Email">
      <input id="consultPhone" type="text" placeholder="Phone (optional)">
      <div class="modal-buttons">
        <button class="btn-secondary" onclick="closeConsultModal()">Cancel</button>
        <button class="btn-primary" id="consultSubmitBtn" onclick="submitConsultRequest()">Request Consult</button>
      </div>
    </div>
  </div>

  <script>
let userSelectedSeverity = null;
let lastAiSummaryForConsult = null;

// Local Symptom Database
const symptomDatabase = {
  fever: {
    severity: 'yellow',
    conditions: [
      { name: 'Common Cold', probability: 45 },
      { name: 'Flu (Influenza)', probability: 40 },
      { name: 'Viral Infection', probability: 35 },
      { name: 'Bacterial Infection', probability: 20 }
    ],
    recommendations: [
      'Rest and get adequate sleep',
      'Drink plenty of fluids (water, herbal tea, warm soup)',
      'Use fever-reducing medications like paracetamol or ibuprofen',
      'Maintain body temperature with light clothing',
      'Consult doctor if fever persists beyond 3 days or exceeds 103¬∞F'
    ]
  },
  cold: {
    severity: 'green',
    conditions: [
      { name: 'Common Cold', probability: 85 },
      { name: 'Seasonal Allergies', probability: 15 },
      { name: 'Early Flu', probability: 10 }
    ],
    recommendations: [
      'Stay hydrated with warm fluids',
      'Use saline nasal drops or spray',
      'Get plenty of rest',
      'Gargle with warm salt water',
      'Vitamin C supplements may help reduce duration'
    ]
  },
  cough: {
    severity: 'yellow',
    conditions: [
      { name: 'Common Cold', probability: 40 },
      { name: 'Bronchitis', probability: 35 },
      { name: 'Asthma', probability: 20 },
      { name: 'Pneumonia', probability: 15 }
    ],
    recommendations: [
      'Stay hydrated and drink warm fluids',
      'Use honey and lemon in warm water',
      'Avoid irritants like smoke and pollution',
      'Use cough drops or lozenges',
      'Seek medical attention if cough persists for more than 2 weeks'
    ]
  },
  vomit: {
    severity: 'yellow',
    conditions: [
      { name: 'Gastroenteritis (Food Poisoning)', probability: 50 },
      { name: 'Nausea/Indigestion', probability: 30 },
      { name: 'Migraine', probability: 15 },
      { name: 'Stomach Ulcer', probability: 10 }
    ],
    recommendations: [
      'Avoid food for first few hours',
      'Sip small amounts of clear fluids (water, ginger ale)',
      'Once stable, eat bland foods like crackers or toast',
      'Avoid dairy and fatty foods',
      'Seek immediate care if vomiting persists or accompanied by severe abdominal pain'
    ]
  },
  diabetes: {
    severity: 'red',
    conditions: [
      { name: 'Type 2 Diabetes', probability: 60 },
      { name: 'Type 1 Diabetes', probability: 25 },
      { name: 'Prediabetes', probability: 15 }
    ],
    recommendations: [
      'Consult an endocrinologist immediately',
      'Monitor blood sugar levels regularly',
      'Maintain a healthy diet low in refined sugars',
      'Exercise regularly (150 minutes per week)',
      'Take prescribed medications consistently',
      'Check feet daily for any sores or infections'
    ]
  },
  bp: {
    severity: 'red',
    conditions: [
      { name: 'Hypertension (High Blood Pressure)', probability: 70 },
      { name: 'Hypotension (Low Blood Pressure)', probability: 20 },
      { name: 'White Coat Syndrome', probability: 10 }
    ],
    recommendations: [
      'See a cardiologist for proper diagnosis',
      'Monitor blood pressure daily at home',
      'Reduce sodium intake',
      'Exercise regularly and manage weight',
      'Manage stress through meditation or yoga',
      'Avoid alcohol and smoking',
      'Take antihypertensive medications as prescribed'
    ]
  },
  headache: {
    severity: 'yellow',
    conditions: [
      { name: 'Tension Headache', probability: 55 },
      { name: 'Migraine', probability: 25 },
      { name: 'Dehydration', probability: 15 },
      { name: 'Sinusitis', probability: 10 }
    ],
    recommendations: [
      'Rest in a quiet, dark room',
      'Apply hot or cold compress to head or neck',
      'Stay hydrated by drinking water',
      'Take over-the-counter pain relievers (ibuprofen, acetaminophen)',
      'Practice relaxation techniques',
      'Seek medical attention if headache is severe or accompanied by vision changes'
    ]
  },
  'body pain': {
    severity: 'yellow',
    conditions: [
      { name: 'Muscle Strain', probability: 40 },
      { name: 'Viral Infection', probability: 30 },
      { name: 'Arthritis', probability: 20 },
      { name: 'Fibromyalgia', probability: 10 }
    ],
    recommendations: [
      'Rest the affected areas',
      'Apply ice packs for first 48 hours, then heat',
      'Take anti-inflammatory medications',
      'Gentle stretching and light movement',
      'Massage or physical therapy may help',
      'Ensure adequate sleep and hydration'
    ]
  },
  weakness: {
    severity: 'yellow',
    conditions: [
      { name: 'Fatigue/Lack of Sleep', probability: 45 },
      { name: 'Anemia', probability: 25 },
      { name: 'Thyroid Disorder', probability: 20 },
      { name: 'Nutritional Deficiency', probability: 15 }
    ],
    recommendations: [
      'Get 7-9 hours of sleep nightly',
      'Eat a balanced diet rich in iron and B vitamins',
      'Stay hydrated throughout the day',
      'Exercise regularly to build strength',
      'Consult a doctor for blood tests if weakness persists',
      'Manage stress and avoid overexertion'
    ]
  }
};

let userDuration = null;

// Slide Navigation Functions
function goToSlide(slideNum) {
  const input = document.getElementById('symptomInput').value.trim();
  
  if (slideNum === 2 && !input) {
    showAlert('Please describe your symptoms');
    return;
  }
  
  if (slideNum === 3 && !userSelectedSeverity) {
    showAlert('Please select a severity level');
    return;
  }
  
  // Hide all slides
  document.querySelectorAll('.slide').forEach(slide => slide.classList.remove('active'));
  
  // Show target slide
  const targetSlide = document.getElementById(`slide-${slideNum}`);
  if (targetSlide) {
    targetSlide.classList.add('active');
    
    // If going to results slide, analyze symptoms
    if (slideNum === 4) {
      analyzeSymptoms();
    }
  }
}

function setSeverity(severity) {
  userSelectedSeverity = severity;
  
  // Update quick button styling
  document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.closest('.quick-btn').classList.add('selected');
  
  // Update display
  const labels = { low: 'üü¢ Low', medium: 'üü° Medium', high: 'üî¥ High' };
  document.getElementById('selectedSeverityDisplay').textContent = labels[severity] || 'Not selected';
}

function setDuration(duration) {
  userDuration = duration;
  document.querySelectorAll('.quick-btn').forEach(btn => btn.classList.remove('selected'));
  event.target.closest('.quick-btn').classList.add('selected');
}

function showAlert(msg) {
  alert(msg);
}

async function callAiAnalyze(text, severity) {
  const res = await fetch('/api/analyze-symptoms', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text, severity })
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: 'unknown' }));
    throw new Error(err?.error || 'AI request failed');
  }
  return await res.json();
}

async function analyzeSymptoms() {
  const inputEl = document.getElementById('symptomInput');
  const input = inputEl.value.trim();
  if (!input) { showAlert('Please describe your symptoms'); return; }
  if (!userSelectedSeverity) { showAlert('Please select a severity level'); return; }

  try {
    const ai = await callAiAnalyze(input, userSelectedSeverity);
    displayResultsFromAi(ai, input);
  } catch (err) {
    console.error(err);
    // Try local database fallback
    const localResult = findLocalMatch(input);
    if (localResult) {
      displayResultsLocal(localResult, input);
      console.log('Using local symptom database (AI service unavailable)');
    } else {
      showAlert('Could not analyze symptoms. Try mentioning: fever, cold, cough, vomit, diabetes, bp, headache, weakness, or body pain.');
    }
  }
}

function findLocalMatch(input) {
  const lowerInput = input.toLowerCase();
  for (let symptom in symptomDatabase) {
    if (lowerInput.includes(symptom)) {
      return { symptom, data: symptomDatabase[symptom] };
    }
  }
  return null;
}

function displayResultsLocal(match, userInput) {
  const { symptom, data } = match;
  const adjustedSeverity = adjustSeverityLevel(data.severity, userSelectedSeverity);
  const adjustedConditions = adjustConditions(data.conditions, userSelectedSeverity);
  const adjustedRecommendations = adjustRecommendations(data.recommendations, userSelectedSeverity);

  document.getElementById('resultSymptom').textContent = userInput;
  const severityBadge = document.getElementById('severityBadge');
  severityBadge.className = `severity-badge severity-${adjustedSeverity}`;
  severityBadge.textContent = getSeverityLabel(adjustedSeverity);

  const conditionsList = document.getElementById('conditionsList');
  conditionsList.innerHTML = adjustedConditions.map(c => {
    const prob = Math.min(100, Math.max(0, Math.round(Number(c.probability) || 0)));
    return `
      <div class="condition-item">
        <span class="condition-name">${c.name}</span>
        <div class="probability">
          <div class="probability-bar">
            <div class="probability-fill" style="width: ${prob}%"></div>
          </div>
          <span class="probability-text">${prob}%</span>
        </div>
      </div>
    `;
  }).join('');

  const recommendationsList = document.getElementById('recommendationsList');
  recommendationsList.innerHTML = adjustedRecommendations.map(r => `<li>${r}</li>`).join('');

  lastAiSummaryForConsult = `Symptoms: ${userInput}\nTop Conditions: ${adjustedConditions.slice(0,3).map(x => x.name + ' (' + x.probability + '%)').join(', ')}\nRecommendations: ${adjustedRecommendations.slice(0,3).join('; ')}`;

  // Show consult button
  document.getElementById('consultButton2').style.display = 'block';
}

function displayResultsFromAi(ai, userInput) {
  const severityBadge = document.getElementById('severityBadge');
  const finalSeverity = ai.severity || 'yellow';
  const conditions = Array.isArray(ai.conditions) ? ai.conditions : [];
  const recommendations = Array.isArray(ai.recommendations) ? ai.recommendations : [];
  const summary = ai.summary || '';

  document.getElementById('resultSymptom').textContent = userInput;
  severityBadge.className = `severity-badge severity-${finalSeverity}`;
  severityBadge.textContent = { green: 'Low', yellow: 'Moderate', red: 'High' }[finalSeverity] || 'Unknown';

  const conditionsList = document.getElementById('conditionsList');
  conditionsList.innerHTML = conditions.map(c => {
    const prob = Math.min(100, Math.max(0, Math.round(Number(c.probability) || 0)));
    return `
      <div class="condition-item">
        <span class="condition-name">${c.name}</span>
        <div class="probability">
          <div class="probability-bar">
            <div class="probability-fill" style="width: ${prob}%"></div>
          </div>
          <span class="probability-text">${prob}%</span>
        </div>
      </div>
    `;
  }).join('');

  const recommendationsList = document.getElementById('recommendationsList');
  recommendationsList.innerHTML = recommendations.map(r => `<li>${r}</li>`).join('');

  lastAiSummaryForConsult = summary || `Symptoms: ${userInput}`;

  // Show consult button
  document.getElementById('consultButton2').style.display = 'block';
}

function openConsultModal() {
  document.getElementById('consultModal').classList.add('show');
  document.getElementById('consultModal').setAttribute('aria-hidden', 'false');
}

function closeConsultModal() {
  document.getElementById('consultModal').classList.remove('show');
  document.getElementById('consultModal').setAttribute('aria-hidden', 'true');
}

async function submitConsultRequest() {
  const name = document.getElementById('consultName').value.trim();
  const email = document.getElementById('consultEmail').value.trim();
  const phone = document.getElementById('consultPhone').value.trim();

  if (!name || !email) { showAlert('Please provide name and email'); return; }

  const submitBtn = document.getElementById('consultSubmitBtn');
  const original = submitBtn.innerText;
  submitBtn.disabled = true;
  submitBtn.innerText = 'Sending...';

  try {
    const res = await fetch('/api/request-consult', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone, summary: lastAiSummaryForConsult || 'No summary' })
    });
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();
    showAlert('Consult request submitted! Reference: ' + (data.requestId || 'N/A'));
    closeConsultModal();
  } catch (err) {
    showAlert('Failed to submit. Try again later.');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = original;
  }
}

// Helper functions for severity and recommendations adjustment
function adjustSeverityLevel(baseSeverity, userSeverity) {
  const severityMap = { green: 0, yellow: 1, red: 2 };
  const severityLevels = ['green', 'yellow', 'red'];
  const baseLevel = severityMap[baseSeverity] ?? 1;
  const userLevel = { low: 0, medium: 1, high: 2 }[userSeverity] ?? 1;
  const adjustedLevel = Math.round((baseLevel + userLevel) / 2);
  return severityLevels[Math.min(2, Math.max(0, adjustedLevel))];
}

function adjustConditions(conditions, userSeverity) {
  const severityMultipliers = { low: 0.7, medium: 1.0, high: 1.3 };
  const multiplier = severityMultipliers[userSeverity] ?? 1.0;
  return conditions
    .map(condition => ({
      ...condition,
      probability: Math.min(100, Math.round(condition.probability * multiplier))
    }))
    .sort((a, b) => b.probability - a.probability);
}

function adjustRecommendations(recommendations, userSeverity) {
  if (userSeverity === 'high') {
    return [
      '‚ö†Ô∏è Seek immediate medical attention or call emergency services',
      '‚ö†Ô∏è Contact your doctor or visit urgent care immediately',
      ...recommendations.slice(0, 2)
    ];
  }
  if (userSeverity === 'low') {
    return [
      'Monitor your symptoms closely',
      'Rest and stay hydrated',
      ...recommendations.slice(0, 2)
    ];
  }
  return recommendations;
}

function getSeverityLabel(severity) {
  const labels = { green: 'Low', yellow: 'Moderate', red: 'High' };
  return labels[severity] || 'Unknown';
}

document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('symptomInput');
  input.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
      analyzeSymptoms();
    }
  });
});
  </script>
  <script src="script.js"></script>
  <script>
    // ============================================
    // UNIFIED HOSPITAL SEARCH FUNCTIONALITY
    // ============================================
    
    // Open the hospital search panel
    function openHospitalSearchPanel() {
      // Show the address panel and by default list top hospitals in KKD
      document.getElementById('addressPanel').style.display = 'block';
      document.getElementById('hospitalsPanel').style.display = 'none';
      document.getElementById('doctorsPanel').style.display = 'none';
      // Directly show top hospitals for KKD by default
      showTopHospitalsKKD();
    }

    // Update status message
    function updateStatusMessage(msg) {
      document.getElementById('statusText').textContent = msg;
    }

    // Load Google Maps script
    async function loadGoogleMapsScript() {
      if (window.google && window.google.maps) return; // Already loaded
      try {
        const keyRes = await fetch('/api/maps-key-server');
        if (!keyRes.ok) throw new Error('Could not get maps key');
        const keyData = await keyRes.json();
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = `https://maps.googleapis.com/maps/api/js?key=${keyData.key}`;
          s.onload = resolve;
          s.onerror = () => reject(new Error('Failed to load maps'));
          document.head.appendChild(s);
        });
      } catch (e) {
        console.error('Map load error:', e);
        updateStatusMessage('‚ö†Ô∏è Could not load maps. Showing list view only.');
      }
    }

    // Unified render function for all hospital results
    async function renderHospitalResults(results, userLocation, searchType) {
      document.getElementById('addressPanel').style.display = 'block';
      document.getElementById('hospitalsPanel').style.display = 'none';
      document.getElementById('doctorsPanel').style.display = 'none';
      
      const list = document.getElementById('addressHospitalsList');
      const mapDiv = document.getElementById('addressMap');
      list.innerHTML = '';
      
      // Update count
      document.getElementById('hospitalCount').textContent = results.length;

      // Load maps
      try {
        await loadGoogleMapsScript();
      } catch (e) {
        console.warn('Maps not available, showing list only');
      }

      // Initialize map if available
      let map = null;
      if (window.google && window.google.maps && userLocation) {
        try {
          map = new google.maps.Map(mapDiv, {
            center: { lat: userLocation.lat, lng: userLocation.lng },
            zoom: 13
          });
          
          // Add user location marker
          new google.maps.Marker({
            position: { lat: userLocation.lat, lng: userLocation.lng },
            map,
            title: 'Your Location',
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
          });
        } catch (e) {
          console.error('Map initialization error:', e);
        }
      }

      // Render hospital list
      if (results.length === 0) {
        list.innerHTML = '<li style="padding: 20px; text-align: center; color: #999;">No hospitals found. Try a different search.</li>';
        updateStatusMessage('No hospitals found in this area.');
        return;
      }

      results.forEach((r) => {
        const li = document.createElement('li');
        li.style.cssText = 'padding:12px; margin-bottom:8px; border-radius:6px; background:#f9f9f9; border-left:4px solid #667eea;';
        
        const ratingStr = r.rating ? `${r.rating}‚≠ê (${r.user_ratings_total || 0} reviews)` : 'No rating';
        const address = r.vicinity || r.formatted_address || 'Address not available';
        
        li.innerHTML = `
          <strong style="font-size:14px; color: #333;">${r.name}</strong>
          <div style="font-size:12px; color:#666; margin-top:4px; line-height: 1.4;">
            üìç ${address}
          </div>
          <div style="font-size:11px; color:#999; margin-top:2px;">‚≠ê ${ratingStr}</div>
          <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
            <button class='btn-secondary' style='padding:6px 10px; font-size:11px;' onclick="showHospitalDetails('${r.place_id}')">Details</button>
            <a class='btn-primary' href='https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(r.name)}&query_place_id=${r.place_id}' target='_blank' style='text-decoration:none; padding:6px 10px; font-size:11px; display:inline-block; border-radius:6px; color:white;'>Directions</a>
          </div>
        `;
        list.appendChild(li);

        // Add map marker
        if (map && r.location) {
          try {
            const marker = new google.maps.Marker({
              position: { lat: r.location.lat, lng: r.location.lng },
              map,
              title: r.name
            });
            marker.addListener('click', () => {
              map.setCenter(marker.getPosition());
              map.setZoom(15);
            });
          } catch (e) {
            console.error('Marker error:', e);
          }
        }
      });

      updateStatusMessage(`‚úì Found ${results.length} hospitals near you.`);
    }

    // Show hospital details
    async function showHospitalDetails(place_id) {
      try {
        const res = await window.getPlaceDetails(place_id);
        const p = res.result || res;
        const details = `
Name: ${p.name || 'N/A'}
Address: ${p.formatted_address || 'N/A'}
Phone: ${p.formatted_phone_number || 'N/A'}
Website: ${p.website || 'N/A'}
Rating: ${p.rating || 'N/A'}
Status: ${p.opening_hours?.open_now ? '‚úì Open Now' : 'Closed'}`;
        alert(details);
      } catch (e) {
        console.error(e);
        alert('Could not fetch hospital details. Try viewing on Google Maps.');
      }
    }

    // SEARCH METHOD 1: By Address
    async function searchHospitalsByAddress() {
      const address = document.getElementById('addressInput').value.trim();
      if (!address) {
        updateStatusMessage('‚ö†Ô∏è Please enter an address');
        return;
      }
      
      const btn = document.querySelector('button[onclick="searchHospitalsByAddress()"]');
      btn.disabled = true;
      btn.innerText = 'Searching...';
      updateStatusMessage('üîç Geocoding address...');
      
      try {
        const result = await window.findNearbyHospitalsFromAddress(address);
        if (result && result.results) {
          renderHospitalResults(result.results, result.userLocation, 'address');
        } else {
          updateStatusMessage('‚ö†Ô∏è No results returned ‚Äî showing top hospitals');
          showTopHospitalsKKD();
        }
      } catch (e) {
        console.error('Search error:', e);
        updateStatusMessage('‚ö†Ô∏è Address not found. Showing top hospitals instead.');
        showTopHospitalsKKD();
      } finally {
        btn.disabled = false;
        btn.innerText = 'Search';
      }
    }

    // SEARCH METHOD 2: By Current Location
    async function searchHospitalsByGPS() {
      if (!navigator.geolocation) {
        updateStatusMessage('‚ö†Ô∏è Geolocation not supported in your browser');
        return;
      }
      
      const btn = document.querySelector('button[onclick="searchHospitalsByGPS()"]');
      btn.disabled = true;
      btn.innerText = 'Locating...';
      updateStatusMessage('üìç Getting your location...');
      
      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          try {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            updateStatusMessage('üîç Finding nearby hospitals...');
            
            const res = await window.findNearbyHospitals(lat, lng, 5000);
            renderHospitalResults(res.results || [], { lat, lng }, 'gps');
          } catch (e) {
            console.error('GPS search error:', e);
            updateStatusMessage('‚ö†Ô∏è Failed to find hospitals at your location');
          } finally {
            btn.disabled = false;
            btn.innerText = 'Use My Location';
          }
        },
        (err) => {
          btn.disabled = false;
          btn.innerText = 'Use My Location';
          updateStatusMessage('‚ö†Ô∏è Location permission denied');
          console.error('Geolocation error:', err);
        }
      );
    }

    // SEARCH METHOD 3: By Region/City
    async function searchHospitalsByRegion() {
      const region = document.getElementById('regionInput').value.trim();
      if (!region) {
        updateStatusMessage('‚ö†Ô∏è Please enter a region or city name');
        return;
      }
      
      const btn = document.querySelector('button[onclick="searchHospitalsByRegion()"]');
      btn.disabled = true;
      btn.innerText = 'Searching...';
      updateStatusMessage('üîç Searching region: ' + region);
      
      try {
        const res = await window.findHospitalsByRegion(region);
        if (res.results && res.results.length > 0) {
          // Get center from first result
          const center = res.results[0].location || { lat: 0, lng: 0 };
          renderHospitalResults(res.results, center, 'region');
        } else {
          updateStatusMessage('‚ö†Ô∏è No hospitals found in that region ‚Äî showing top hospitals');
          // if user searched for KKD or similar, show KKD top hospitals; otherwise show KKD as safe fallback
          showTopHospitalsKKD();
        }
      } catch (e) {
        console.error('Region search error:', e);
        updateStatusMessage('‚ö†Ô∏è Region search failed. Showing top hospitals instead.');
        showTopHospitalsKKD();
      } finally {
        btn.disabled = false;
        btn.innerText = 'Search';
      }
    }

    // Top hospitals for KKD (static list used as default when user clicks Find Hospitals)
    // Kakinada coordinates: ~16.9891, 82.2475
    const topHospitalsKKD = [
      { id: 'kkd-sri-vijaya', name: 'Sri Vijayalakshmi Multispeciality Hospital', address: 'Jagganpeta, Kakinada, Andhra Pradesh', phone: '070138 69229', rating: 5.0, notes: 'Highly recommended', open24: true, location: { lat: 16.9945, lng: 82.2654 } },
      { id: 'kkd-city-multi', name: 'City Multispeciality Hospital', address: 'Kakinada, Andhra Pradesh', phone: '095848 13333', rating: 4.8, notes: 'Orthopedic | Neurology | ENT | Rheumatology', open24: true, location: { lat: 16.9876, lng: 82.2542 } },
      { id: 'kkd-apollo', name: 'Apollo Hospitals Kakinada', address: 'Kakinada, Andhra Pradesh', phone: '080 6904 9760', rating: 4.8, website: '', notes: 'General hospital', open24: true, location: { lat: 16.9823, lng: 82.2658 } },
      { id: 'kkd-inodaya', name: 'INODAYA HOSPITALS', address: 'Kakinada, Andhra Pradesh', phone: '0884 233 3033', rating: 4.8, notes: 'Multispeciality', open24: true, location: { lat: 16.9891, lng: 82.2475 } },
      { id: 'kkd-1', name: 'KKD General Hospital', address: '12 Main St, KKD', phone: '+1-555-0101', rating: 4.5, location: { lat: 16.99, lng: 82.25 } },
      { id: 'kkd-2', name: 'St. Mary Clinic', address: '4 Church Rd, KKD', phone: '+1-555-0102', rating: 4.2, location: { lat: 16.98, lng: 82.26 } },
      { id: 'kkd-3', name: 'City Emergency Center', address: '88 Health Ave, KKD', phone: '+1-555-0103', rating: 4.7, location: { lat: 16.97, lng: 82.27 } }
    ];

    async function showTopHospitalsKKD() {
      const list = document.getElementById('addressHospitalsList');
      const mapDiv = document.getElementById('addressMap');
      document.getElementById('addressPanel').style.display = 'block';
      updateStatusMessage('Showing top hospitals in KKD');
      list.innerHTML = '';
      if (mapDiv) mapDiv.innerHTML = '<img src="public/kakinada-map.png" style="width:100%; height:100%; object-fit:cover; border-radius:8px;" alt="Kakinada Hospitals Map" />';

      // Render each hospital
      topHospitalsKKD.forEach((hosp) => {
        const li = document.createElement('li');
        li.style.cssText = 'padding:12px; margin-bottom:8px; border-radius:6px; background:#f9f9f9; border-left:4px solid #667eea;';

        const directionsHref = hosp.location ?
          `https://www.google.com/maps/search/?api=1&query=${hosp.location.lat},${hosp.location.lng}` :
          `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hosp.address || hosp.name)}`;

        li.innerHTML = `
          <strong style="font-size:14px; color: #333;">${hosp.name}</strong>
          <div style="font-size:12px; color:#666; margin-top:4px;">üìç ${hosp.address}</div>
          <div style="font-size:11px; color:#999; margin-top:2px;">‚≠ê ${hosp.rating || 'N/A'}</div>
          <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
            <button class='btn-secondary' style='padding:6px 10px; font-size:11px;' onclick="alert('Phone: ${hosp.phone || 'N/A'}')">Contact</button>
            <a class='btn-primary' href='${directionsHref}' target='_blank' style='text-decoration:none; padding:6px 10px; font-size:11px; display:inline-block; border-radius:6px; color:white;'>Directions</a>
          </div>
        `;

        list.appendChild(li);
      });

      document.getElementById('hospitalCount').textContent = topHospitalsKKD.length;
      updateStatusMessage(`‚úì ${topHospitalsKKD.length} top hospitals (KKD)`);
    }
  </script>
</body>
</html>
